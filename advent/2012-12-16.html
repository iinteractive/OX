<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.111" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
Configuration with OX

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">2012 
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Configuration with OX</h1>
<div class='subtitle'>OX - 2012-12-16</div>

<div class='pod'><p><a href="https://metacpan.org/module/OX">OX</a> has no built-in configuration management system. Instead, the design of OX makes it easy to roll your own. Typically configuration will be a layer outside of your application, such that your configuration initializes your application.</p>

<p>This article describes one opinionated way to structure your application&#39;s configuration using <a href="https://metacpan.org/module/Config::JFDI">Config::JFDI</a>. There are many like it, but this one is mine.</p>

<h3 id="Site-Specific-Configuration">Site-Specific Configuration</h3>

<p>As an application grows out of its prototype and early design phases, it becomes more and more important that it adapt to each environment it runs in. For example, you might need to start running the production database on a different machine just to spread the load around. So you change the <code>dsn</code> from <code>localhost</code> to <code>db.example.com</code>. Done deal!</p>

<p>Except now all the developers are testing their local changes against the production database. That&#39;s nuts!</p>

<p>What you really want is a configuration file for developers which specifies that their database lives on <code>localhost</code>, and a production configuration file which points to <code>db.example.com</code>. This approach scales to additional environments like a QA site, a continuous-integration machine, and so on. You might even have a second, unversioned config file where each developer can put config specific to their machine.</p>

<h3 id="Implementation">Implementation</h3>

<h4 id="MyApp::Config"><code>MyApp::Config</code></h4>

<p>The centerpiece of this opinionated design is an <code>MyApp::Config</code> which is a class that, unsurprisingly, manages the configuration of this application. This class is responsible for deciding which config file to load (production? development?) and keeping track of the contents of that file. Here&#39;s what it might look like:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> MyApp::Config</span>;<br /><span class="synStatement">use </span><span class="synConstant">5.16.0</span>;<br /><span class="synStatement">use </span>Moose;<br /><span class="synStatement">use </span>Config::JFDI;<br /><br />has <span class="synConstant">filename</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is</span>      =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">isa</span>     =&gt; <span class="synConstant">'Str'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">default</span> =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;myapp.</span><span class="synIdentifier">$ENV{</span><span class="synConstant">MYAPP_CONFIG_SUFFIX</span><span class="synIdentifier">}</span><span class="synConstant">&quot;</span> },<br />);<br /><br />has <span class="synConstant">config</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is</span>      =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">isa</span>     =&gt; <span class="synConstant">'Config::JFDI'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">lazy</span>    =&gt; <span class="synConstant">1</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">default</span> =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$self</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> Config::JFDI-&gt;new(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">name</span> =&gt; <span class="synIdentifier">$self-&gt;filename</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">path</span> =&gt; <span class="synConstant">'config/'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />);<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">get </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$key</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$self-&gt;config-&gt;config-&gt;{$key}</span>;<br />}<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">as_hash </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$self</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$self-&gt;config-&gt;config</span>;<br />}</code><br />&nbsp;</td></table>

<p>The <code>filename</code> attribute looks at the <code>MYAPP_CONFIG_SUFFIX</code> environment variable to decide which config file to use. The suffix corresponds to the environment the application is in. For developers the suffix might be <code>dev</code>, and for production the suffix might be <code>prod</code>. This means that <a href="https://metacpan.org/module/Config::JFDI">Config::JFDI</a> will try to load <code>config/myapp.dev.yml</code> for developers and <code>config/myapp.prod.yml</code> in production. (<a href="https://metacpan.org/module/Config::JFDI">Config::JFDI</a> supports loading many different file formats, but for config I prefer <a href="https://metacpan.org/module/YAML">YAML</a>.)</p>

<p>I like providing <code>get</code> and <code>as_hash</code> methods in my config class to hide the implementation details of <a href="https://metacpan.org/module/Config::JFDI">Config::JFDI</a> as much as possible. Otherwise, pulling a setting&#39;s value out would involve calling <code>$config-&gt;config-&gt;config-&gt;{dsn}</code>, and that is an awful lot to ask of anybody. Instead, now <code>$config-&gt;get(&quot;dsn&quot;)</code> suffices.</p>

<h4 id="config-myapp.-.yml"><code>config/myapp.*.yml</code></h4>

<p>The config file is simply YAML. The developer config might look like:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synPreProc">---</span><br /><span class="synIdentifier">dsn</span><span class="synSpecial">:</span> <span class="synConstant">'mysql:database=myapp;host=localhost'</span><br /><span class="synIdentifier">compile_templates</span><span class="synSpecial">:</span> <span class="synConstant">0</span></code><br />&nbsp;</td></table>

<p>The production config might look like:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synPreProc">---</span><br /><span class="synIdentifier">dsn</span><span class="synSpecial">:</span> <span class="synConstant">'mysql:database=myapp;host=db.example.com'</span><br /><span class="synIdentifier">compile_templates</span><span class="synSpecial">:</span> <span class="synConstant">1</span></code><br />&nbsp;</td></table>

<p>No problem!</p>

<h4 id="app.psgi"><code>app.psgi</code></h4>

<p>We have a config file and a config loader, but these aren&#39;t actually being used anywhere. <a href="https://metacpan.org/module/OX">OX</a> certainly won&#39;t intuit that these components exist, since explicit declarations are The OX Way. So how do we use our config?</p>

<p>The answer is probably what you&#39;d expect: you load config to use when instantiating your application. You simply just pass the config variables to <code>MyApp-&gt;new(...)</code>. Your PSGI script would then look like this:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">use </span>MyApp;<br /><span class="synStatement">use </span>MyApp::Config;<br /><span class="synStatement">my</span> <span class="synIdentifier">$config</span> = MyApp::Config-&gt;new;<br /><br />MyApp-&gt;new(<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">dsn</span>               =&gt; <span class="synIdentifier">$config-&gt;get</span>(<span class="synConstant">'dsn'</span>),<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">compile_templates</span> =&gt; <span class="synIdentifier">$config-&gt;get</span>(<span class="synConstant">'compile_templates'</span>),<br />)-&gt;to_app;</code><br />&nbsp;</td></table>

<p>Since you&#39;re probably going to end up adding many different options, you&#39;ll want that to have as little friction as possible. After all, that kind of code is a breeding ground for merge conflicts. Instead, just pass everything the config specifies into <code>MyApp-&gt;new</code>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>MyApp-&gt;new(<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">%{</span> <span class="synIdentifier">$config-&gt;as_hash</span> <span class="synIdentifier">}</span>,<br />);</code><br />&nbsp;</td></table>

<h4 id="MyApp"><code>MyApp</code></h4>

<p>The final piece is making <code>MyApp</code> accept and use these new constructor parameters. Since <code>MyApp</code> uses <a href="https://metacpan.org/module/Bread::Board::Declare">Bread::Board::Declare</a> you can create services for each of these parameters with the familiar <a href="https://metacpan.org/module/Moose#has">&quot;has&quot; in Moose</a> syntax.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>has <span class="synConstant">dsn</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is</span>       =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">isa</span>      =&gt; <span class="synConstant">'Str'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">required</span> =&gt; <span class="synConstant">1</span>,<br />);<br /><br />has <span class="synConstant">compile_templates</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is</span>       =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">isa</span>      =&gt; <span class="synConstant">'Bool'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">required</span> =&gt; <span class="synConstant">1</span>,<br />);</code><br />&nbsp;</td></table>

<p>Finally, using the magic of <a href="https://metacpan.org/module/Bread::Board">Bread::Board</a> you can wire these new services into your existing <code>database</code> and <code>view</code> attributes.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>has <span class="synConstant">database</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is</span>           =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">dependencies</span> =&gt; [<span class="synConstant">qw[dsn]</span>],<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">block</span>        =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$s</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$dsn</span> = <span class="synIdentifier">$s-&gt;param</span>(<span class="synConstant">'dsn'</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> DBI-&gt;<span class="synStatement">connect</span>(<span class="synIdentifier">$dsn</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />);<br /><br />has <span class="synConstant">view</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is</span>           =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">dependencies</span> =&gt; [<span class="synConstant">qw[compile_templates]</span>],<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">block</span>        =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$s</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$compile_templates</span> = <span class="synIdentifier">$s-&gt;param</span>(<span class="synConstant">'compile_templates'</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> ...<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />);</code><br />&nbsp;</td></table>

<h3 id="Developer-Specific-Configuration">Developer-Specific Configuration</h3>

<p>One of the many benefits of using a system like <a href="https://metacpan.org/module/Config::JFDI">Config::JFDI</a> is that it supports <i>overlays</i>. An individual developer can adjust specific settings in a file called <code>config/myapp.dev_local.yml</code> which will be merged with the baseline config in <code>config/myapp.dev.yml</code>. Say one of the developers runs their MySQL on a different machine. That developer can put this into a <code>config/myapp.dev_local.yml</code>:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synPreProc">---</span><br /><span class="synIdentifier">dsn</span><span class="synSpecial">:</span> <span class="synConstant">'mysql:database=myapp;host=arrakis.local'</span></code><br />&nbsp;</td></table>

<p>Now, when <a href="https://metacpan.org/module/DBI">DBI</a> connects to the database on this developer&#39;s machine, it will get the correct <code>dsn</code>. And it won&#39;t disrupt anyone else, because this config file is specific to that developer. Finally, since <code>_local</code> configs inherit settings from the baseline config file, options like <code>compile_templates</code> will trickle down from the ordinary developer config file.</p>

<p>This works especially well if you version <code>config/myapp.dev.yml</code> and put <code>config/myapp.dev_local.yml</code> into <code>.gitignore</code>. That way if a developer adds new baseline config to <code>config/myapp.dev.yml</code>, everyone gets it for free; no vigilance needed.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/4270564691336d543cbef1c6a88446f4?r=g&s=80&d=retro />
This article contributed by: Shawn M Moore &lt;shawn.moore@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Options For Simple Authentication" href="2012-12-15.html">Previous</a></li>

    <li class="next"><a title="Custom Route Builders" href="2012-12-17.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





