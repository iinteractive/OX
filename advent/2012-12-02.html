<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.108" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
Route Builders and Actions

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">
          <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Route Builders and Actions</h1>
<div class='subtitle'>OX - 2012-12-02</div>

<div class='pod'><h2 id="The-route-keyword">The <code>route</code> keyword</h2>

<p>The <code>route</code> keyword maps a <i>path</i> to an <i>action spec</i>. A path is a pattern that resembles a URI path, which OX attempts to match against the incoming request URI. An action spec can take many forms, but it essentially describes what code will run when the corresponding path is matched. The path syntax and features will be described tomorrow, but today&#39;s article is about how the action spec is interpreted.</p>

<h2 id="Route-builders">Route builders</h2>

<p>Route builders are the part of OX which takes an action spec and determines which code to run when its associated path is matched. For instance, in this router:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>router as {<br />&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/'</span>          =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;Hello world!&quot;</span> };<br />&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/posts/:id'</span> =&gt; <span class="synConstant">'posts.view'</span>;<br />};</code><br />&nbsp;</td></table>

<p><code>/</code> uses a route builder which just calls the given coderef directly, while <code>/posts/24</code> uses a route builder which generates a coderef to call the <code>view</code> method on the <code>posts</code> controller.</p>

<p>There are three default route builders for OX applications:</p>

<ul>

<li><p><a href="https://metacpan.org/module/OX::RouteBuilder::Code">OX::RouteBuilder::Code</a></p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>route <span class="synConstant">'/'</span> =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;Hello world!&quot;</span> };</code><br />&nbsp;</td></table>

<p>This route builder will be used whenever the action spec is a coderef. It is the most basic route builder - it just allows you to specify a coderef to call when the route is chosen.</p>

</li>
<li><p><a href="https://metacpan.org/module/OX::RouteBuilder::ControllerAction">OX::RouteBuilder::ControllerAction</a></p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>route <span class="synConstant">'/'</span> =&gt; <span class="synConstant">'root.index'</span>;</code><br />&nbsp;</td></table>

<p>The ControllerAction route builder will be used if the action spec consists of two words (<code>\w+</code>) separated by a period. Those two words will be used to look up a controller to use and a method to call on that controller. The controller is looked up by name among the attributes on the OX application (really services, but we will discuss that when we explain Bread::Board).</p>

<p>The code which is run for the above example is roughly equivalent to:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$controller</span> = <span class="synIdentifier">$self-&gt;root</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$controller-&gt;index</span>(<span class="synIdentifier">@_</span>);<br />}</code><br />&nbsp;</td></table>

</li>
<li><p><a href="https://metacpan.org/module/OX::RouteBuilder::HTTPMethod">OX::RouteBuilder::HTTPMethod</a></p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>route <span class="synConstant">'/'</span> =&gt; <span class="synConstant">'root'</span>;</code><br />&nbsp;</td></table>

<p>The HTTPMethod route builder will be used if the action spec consists of a single word (<code>\w+</code>). This word will be used to look up a controller as in the ControllerAction route builder, but the method to call will be the lowercase version of the HTTP method used (<code>get</code>, <code>post</code>, etc). If no appropriate method is found in the class, it will attempt to call the method named <code>any</code> instead. If that is also not found, the request will return a 405 error.</p>

<p>The code which is run for the above example is roughly equivalent to:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$r</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$controller</span> = <span class="synIdentifier">$self-&gt;root</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$method</span> = <span class="synStatement">lc</span>(<span class="synIdentifier">$r-&gt;method</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$method</span> = <span class="synConstant">'any'</span>             <span class="synStatement">if</span> !<span class="synIdentifier">$controller-&gt;can</span>(<span class="synIdentifier">$method</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> [<span class="synConstant">405</span>, [], [<span class="synConstant">&quot;error&quot;</span>]] <span class="synStatement">if</span> !<span class="synIdentifier">$controller-&gt;can</span>(<span class="synIdentifier">$method</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$controller-&gt;$method</span>(<span class="synIdentifier">@_</span>);<br />}</code><br />&nbsp;</td></table>

</li>
</ul>

<p>You can also define your own route builders, but doing so will be covered in another article.</p>

<h2 id="Actions">Actions</h2>

<p>Once OX determines which code to run to fulfill the request, it will call that code. The code that is called will receive an <a href="https://metacpan.org/module/OX::Request">OX::Request</a> object as its first argument (other than the invocant, if called as a method), which can be used to access all of the request information. The action code should return the response to use, which can be any of:</p>

<ul>

<li><p>Any valid <a href="https://metacpan.org/module/PSGI">PSGI</a> response</p>

<p>This will be used as-is.</p>

</li>
<li><p>A string</p>

<p>This will result in a response with a 200 response code and <code>Content-Type</code> set to <code>text/html</code>.</p>

</li>
<li><p>An <a href="https://metacpan.org/module/OX::Response">OX::Response</a> object</p>

<p>This will use the result of calling the <code>finalize</code> method. This will typically be generated by calling <code>new_response</code> on the request object that you receive.</p>

</li>
</ul>

<p>All requests will be decoded and all responses will be encoded as UTF-8 automatically, so your application can deal entirely with Unicode strings. This behavior can be changed if necessary, but we will discuss that in a future post.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/615c9501f43cca57a2467232c5257544?r=g&s=80&d=retro />
This article contributed by: Jesse Luehrs &lt;jesse.luehrs@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Introduction to OX" href="2012-12-01.html">Previous</a></li>

    <li class="next">Next</li>
</ul>
<div style="clear: both"></div>

        </div>
    </div>
</body>
</html>



