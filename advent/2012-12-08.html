<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.108" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
OX::Request and OX::Response

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">
          <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>OX::Request and OX::Response</h1>
<div class='subtitle'>OX - 2012-12-08</div>

<div class='pod'><h2 id="OX::Request">OX::Request</h2>

<p>As mentioned previously, action subroutines and methods receive an <a href="https://metacpan.org/module/OX::Request">OX::Request</a> instance containing the request data as their first argument. OX::Request provides access to all of the request data that the application received for the current request. Everything from the PSGI environment is available in a nicely packaged object, as well as details of how OX matched the request against your router. There are even shortcuts to build OX::Response objects for your convenience.</p>

<h3 id="Basic-request-data">Basic request data</h3>

<p>The OX::Request instance provides methods to access all of the various parts of the request. Some commonly used methods include:</p>

<ul>

<li><p><code>$r-&gt;path</code></p>

<p>Returns the request path.</p>

</li>
<li><p><code>$r-&gt;method</code></p>

<p>Returns the HTTP method (GET, POST, etc) that was used for the request.</p>

</li>
<li><p><code>$r-&gt;headers</code></p>

<p>Returns an <a href="https://metacpan.org/module/HTTP::Headers">HTTP::Headers</a> object containing the headers in the request.</p>

</li>
<li><p><code>$r-&gt;param($name)</code>, <code>$r-&gt;parameters</code></p>

<p>Allows access to the request parameters, either from the the query string or from the request body. The <code>param</code> method returns the value for a single parameter, while the <code>parameters</code> method returns a hashref of all parameters given.</p>

</li>
<li><p><code>$r-&gt;uploads</code></p>

<p>Returns a hashref of upload objects, which can be used to access uploaded files.</p>

</li>
</ul>

<p>OX::Request is a subclass of <a href="https://metacpan.org/module/Web::Request">Web::Request</a>, so you can find more details in its documentation.</p>

<h3 id="Encoding">Encoding</h3>

<p>By default, OX decodes all request data as UTF-8 before passing it to the application, and encodes all response data as UTF-8 before sending it back to the server. This is almost certainly what you should be doing in any new applications - UTF-8 is used by over half of all websites. If you need to handle different encodings, however, you can adjust the request object to handle things however you want. The <code>encoding</code> method will allow you to set any encoding supported by <a href="https://metacpan.org/module/Encode">Encode</a>, or <code>undef</code> to do no encoding at all. For instance:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">sub </span><span class="synIdentifier">index </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$r</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$r-&gt;encoding</span>(<span class="synConstant">'latin1'</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$page</span> = <span class="synIdentifier">$r-&gt;param</span>(<span class="synConstant">'page'</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synComment"># ...</span><br />}</code><br />&nbsp;</td></table>

<p>This will set <code>$page</code> to the value of the <code>page</code> parameter, assuming that the request encoded the <code>page</code> parameter using the latin1 encoding.</p>

<p>The <code>encoding</code> value is also used to encode the response. By default, all responses will be encoded as UTF-8, but if you need to return something like a binary file, you can do this:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">sub </span><span class="synIdentifier">index </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$r</span>) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synComment"># ...</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$r-&gt;encoding</span>(<span class="synStatement">undef</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">200</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="synConstant">'Content-Type'</span> =&gt; <span class="synConstant">'application/pdf'</span> ],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="synIdentifier">$pdf_contents</span> ],<br />&nbsp;&nbsp;&nbsp;&nbsp;];<br />}</code><br />&nbsp;</td></table>

<p>This ensures that the binary data in the file will not be corrupted by trying to encode it as UTF-8 before returning it.</p>

<h3 id="Routing-details">Routing details</h3>

<p>You can also access the route description for the matched route via the <code>$r-&gt;mapping</code> method. This will return a hashref containing all of the path variables. In addition, this hashref may contain additional data, either added by the route builder or specified in the route description itself. For instance, the ControllerAction route builder adds keys for <code>controller</code> and <code>action</code>, and the HTTPMethod route builder adds a <code>controller</code> key.</p>

<p>You can specify additional elements to add to the mapping hashref in your route descriptions by specifying them in the hash along with your variable validations - values specified in this way are called <i>defaults</i>. For instance:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>route <span class="synConstant">'/news.xml'</span> =&gt; <span class="synConstant">'feeds.news'</span>, (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">formatter</span> =&gt; <span class="synConstant">'Data::Feed::RSS'</span>,<br />);<br /><br />route <span class="synConstant">'/news.atom'</span> =&gt; <span class="synConstant">'feeds.news'</span>, (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">formatter</span> =&gt; <span class="synConstant">'Data::Feed::Atom'</span>,<br />);</code><br />&nbsp;</td></table>

<p>In this case, the mapping hashref will contain a key for <code>formatter</code> which contains the name of the formatter class to use. The <code>news</code> action can then use this value to determine how to format the response, rather than having to guess by inspecting the request path.</p>

<h2 id="OX::Response">OX::Response</h2>

<p>If you need to return more complicated responses (with headers, cookies, and things like that), you can use <a href="https://metacpan.org/module/OX::Response">OX::Response</a> (a subclass of <a href="https://metacpan.org/module/Web::Response">Web::Response</a>) to make this process easier. You can create an OX::Response object by calling the <code>new_response</code> method on the request object, and then setting the various values via methods on the response object. For instance:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">my</span> <span class="synIdentifier">$res</span> = <span class="synIdentifier">$r-&gt;new_response</span>;<br /><span class="synIdentifier">$res-&gt;status</span>(<span class="synConstant">200</span>);<br /><span class="synStatement">if</span> (<span class="synIdentifier">$is_internet_explorer</span>) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$res-&gt;content_type</span>(<span class="synConstant">'application/vnd.ms-excel'</span>);<br />}<br /><span class="synStatement">else</span> {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$res-&gt;content_type</span>(<span class="synConstant">'text/csv'</span>);<br />}<br /><span class="synIdentifier">$res-&gt;content</span>(<span class="synConstant">&quot;foo,bar</span><span class="synSpecial">\n</span><span class="synConstant">baz,quux</span><span class="synSpecial">\n</span><span class="synConstant">&quot;</span>);<br /><span class="synStatement">return</span> <span class="synIdentifier">$res</span>;</code><br />&nbsp;</td></table>

<p><code>new_response</code> can also take key/value pairs to populate initial values for <code>status</code>, <code>headers</code>, <code>content</code>, etc, or it can also take a valid (possibly partial) PSGI response to set some initial values:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">my</span> <span class="synIdentifier">$res</span> = <span class="synIdentifier">$r-&gt;new_response</span>([<span class="synConstant">200</span>, [<span class="synConstant">&quot;X-My-App&quot;</span> =&gt; <span class="synConstant">&quot;MyApp&quot;</span>]]);<br /><span class="synStatement">if</span> (<span class="synIdentifier">$is_internet_explorer</span>) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$res-&gt;content_type</span>(<span class="synConstant">'application/vnd.ms-excel'</span>);<br />}<br /><span class="synStatement">else</span> {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$res-&gt;content_type</span>(<span class="synConstant">'text/csv'</span>);<br />}<br /><span class="synIdentifier">$res-&gt;content</span>(<span class="synConstant">&quot;foo,bar</span><span class="synSpecial">\n</span><span class="synConstant">baz,quux</span><span class="synSpecial">\n</span><span class="synConstant">&quot;</span>);<br /><span class="synStatement">return</span> <span class="synIdentifier">$res</span>;</code><br />&nbsp;</td></table>

<p>See <a href="https://metacpan.org/module/Web::Response">Web::Response</a> for more details about the full functionality available.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/615c9501f43cca57a2467232c5257544?r=g&s=80&d=retro />
This article contributed by: Jesse Luehrs &lt;jesse.luehrs@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="PSGI" href="2012-12-07.html">Previous</a></li>

    <li class="next"><a title="uri_for" href="2012-12-09.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>
    </div>
</body>
</html>



