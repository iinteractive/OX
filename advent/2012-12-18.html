<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.111" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
Authentication And Authorization

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">2012 
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Authentication And Authorization</h1>
<div class='subtitle'>OX - 2012-12-18</div>

<div class='pod'><h2 id="Big-Kid-Pants">Big Kid Pants</h2>

<p>At some point during the development of your application, the simple authentication options that were discussed earlier are going to become insufficient. You&#39;re going to want real user identities to authenticate against, and you&#39;re going to want to assign permissions within your application based on those accounts.</p>

<p>Time to put on the big kid pants and implement authentication and authorization based on information stored in your model layer.</p>

<h2 id="Database-Schema">Database Schema</h2>

<p>First, let&#39;s figure out our database schema classes. Obviously we&#39;re going to have <code>users</code> and <code>permissions</code> tables, as well as a <code>user_permissions</code> junction table to map between them -- a fairly standard setup. Because a minimal DBIC version of this takes up around a hundred lines of code, only the <a href="https://metacpan.org/module/DBIx::Class::ResultSource">ResultSource</a> file for the <code>users</code> table is shown here; the rest of the code can be viewed at <a href="https://github.com/genehack/oxauth">https://github.com/genehack/oxauth</a>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXauth::Schema::Result::Users</span>;<br /><span class="synStatement">use parent</span> <span class="synConstant">qw/ DBIx::Class::Core /</span>;<br /><br /><span class="synStatement">use strict</span>;<br /><span class="synStatement">use warnings</span>;<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;load_components</span>( <span class="synConstant">qw/ PK::Auto PassphraseColumn /</span> );<br />__PACKAGE__<span class="synIdentifier">-&gt;table</span>( <span class="synConstant">'users'</span> );<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;add_column</span>(<br />&nbsp;&nbsp;<span class="synConstant">id</span> =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">data_type</span>   =&gt; <span class="synConstant">'integer'</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is_nullable</span> =&gt; <span class="synConstant">0</span><br />&nbsp;&nbsp;} ,<br />&nbsp;&nbsp;<span class="synConstant">username</span> =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">data_type</span>   =&gt; <span class="synConstant">'varying character'</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">size</span>        =&gt; <span class="synConstant">255</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is_nullable</span> =&gt; <span class="synConstant">0</span> ,<br />&nbsp;&nbsp;} ,<br />&nbsp;&nbsp;<span class="synConstant">password</span> =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">data_type</span>        =&gt; <span class="synConstant">'text'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is_nullable</span>      =&gt; <span class="synConstant">0</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">passphrase</span>       =&gt; <span class="synConstant">'rfc2307'</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">passphrase_class</span> =&gt; <span class="synConstant">'BlowfishCrypt'</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">passphrase_args</span>  =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">salt_random</span> =&gt; <span class="synConstant">1</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">cost</span>        =&gt; <span class="synConstant">14</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">passphrase_check_method</span> =&gt; <span class="synConstant">'check_passphrase'</span> ,<br />&nbsp;&nbsp;} ,<br />&nbsp;&nbsp;<span class="synConstant">name</span> =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">data_type</span>   =&gt; <span class="synConstant">'varying character'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">size</span>        =&gt;  <span class="synConstant">255</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is_nullable</span> =&gt; <span class="synConstant">1</span> ,<br />&nbsp;&nbsp;} ,<br />);<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;set_primary_key</span>( <span class="synConstant">qw/ id /</span> );<br />__PACKAGE__<span class="synIdentifier">-&gt;add_unique_constraint</span>([ <span class="synConstant">qw/ username /</span> ]);<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;has_many</span>(<br />&nbsp;&nbsp;<span class="synConstant">user_permissions</span> =&gt; <span class="synConstant">'OXauth::Schema::Result::UserPermissions'</span> =&gt; <span class="synConstant">'user_id'</span><br />);<br />__PACKAGE__<span class="synIdentifier">-&gt;many_to_many</span>( <span class="synConstant">permissions</span> =&gt; <span class="synConstant">user_permissions</span> =&gt; <span class="synConstant">'permission'</span> );<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">has_permission_to </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$query</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$self-&gt;permissions-&gt;search</span>({ <span class="synConstant">name</span> =&gt; <span class="synIdentifier">$query</span> })-&gt;count &gt; <span class="synConstant">0</span> ? <span class="synConstant">1</span> : <span class="synConstant">0</span>;<br />}<br /><br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>A few points worth noting:</p>

<ul>

<li><p>We&#39;re using <a href="https://metacpan.org/module/DBIx::Class::PassphraseColumn">DBIx::Class::PassphraseColumn</a> to make handling passwords easier.</p>

</li>
<li><p>We defined the appropriate relationships between our tables so that we can easily find what permissions a given user has -- but we&#39;ve gone a step further and written a <code>has_permission_to</code> method in the Users result class to easily check if a given user has a given permission. We&#39;ll see this in action later.</p>

</li>
</ul>

<p>(<i>N.b.</i>: If you&#39;re looking at the code in the <a href="https://github.com/genehack/oxauth">repository</a>, there&#39;s a simple script in <code>bin/deploy</code> that will create a SQLite database with some sample data.)</p>

<h2 id="Application">Application</h2>

<p>Now that we&#39;ve got the schema, let&#39;s see how it fits into our <a href="https://metacpan.org/module/OX">OX</a> application.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXauth</span>;<br /><span class="synComment"># ABSTRACT: OX advent auth example</span><br /><span class="synStatement">use </span>OX;<br /><span class="synStatement">use </span><span class="synConstant">5.010</span>;<br /><br /><span class="synStatement">use </span>OXauth::Schema;<br /><br />has <span class="synConstant">connect_info</span> =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span>, <span class="synConstant">isa</span> =&gt; <span class="synConstant">'ArrayRef'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br /><br />has <span class="synConstant">model</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>           =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>          =&gt; <span class="synConstant">'OXauth::Schema'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">dependencies</span> =&gt; [ <span class="synConstant">'connect_info'</span> ] ,<br />&nbsp;&nbsp;<span class="synConstant">lifecycle</span>    =&gt; <span class="synConstant">'Singleton'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">block</span>        =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;OXauth::Schema-&gt;<span class="synStatement">connect</span>( <span class="synIdentifier">@{</span> <span class="synStatement">shift</span><span class="synIdentifier">-&gt;param( </span><span class="synConstant">'connect_info'</span><span class="synIdentifier"> )}</span> )<br />&nbsp;&nbsp;} ,<br />);<br /><br />has <span class="synConstant">cache_dir</span>     =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">template_root</span> =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br /><br />has <span class="synConstant">view</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>           =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>          =&gt; <span class="synConstant">'Text::Xslate'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">dependencies</span> =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">cache_dir</span> =&gt; <span class="synConstant">'cache_dir'</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">path</span>      =&gt; <span class="synConstant">'template_root'</span> ,<br />&nbsp;&nbsp;},<br />);<br /><br />has <span class="synConstant">admin_controller</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>    =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>   =&gt; <span class="synConstant">'OXauth::Controller::Admin'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">infer</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br />has <span class="synConstant">auth_controller</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>    =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>   =&gt; <span class="synConstant">'OXauth::Controller::Auth'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">infer</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br />has <span class="synConstant">root_controller</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>    =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>   =&gt; <span class="synConstant">'OXauth::Controller::Root'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">infer</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br />router as {<br />&nbsp;&nbsp;wrap <span class="synConstant">'Plack::Middleware::Session'</span> =&gt; ( <span class="synConstant">store</span> =&gt; literal( <span class="synConstant">'File'</span> ));<br /><br />&nbsp;&nbsp;route <span class="synConstant">'/'</span>       =&gt; <span class="synConstant">'root_controller.index'</span>;<br />&nbsp;&nbsp;route <span class="synConstant">'/login'</span>  =&gt; <span class="synConstant">'auth_controller.login'</span>;<br />&nbsp;&nbsp;route <span class="synConstant">'/logout'</span> =&gt; <span class="synConstant">'auth_controller.logout'</span>;<br />&nbsp;&nbsp;route <span class="synConstant">'/admin'</span>  =&gt; <span class="synConstant">'admin_controller.index'</span>;<br />&nbsp;&nbsp;route <span class="synConstant">'/denied'</span> =&gt; <span class="synConstant">'root_controller.deny'</span>;<br />};<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<h2 id="Those-Who-Know-Me-Have-No-Need-Of-My-Name">Those Who Know Me Have No Need Of My Name</h2>

<p>The <code>auth_controller</code> service, an instance of <code>OXauth::Controller::Auth</code>, is where all the authentication code lives. Let&#39;s see what that looks like:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXauth::Controller::Auth</span>;<br /><span class="synStatement">use </span>Moose;<br />extends <span class="synConstant">'OXauth::Controller'</span>;<br /><br /><span class="synStatement">use </span>HTTP::Throwable::Factory <span class="synConstant">qw/ http_throw /</span>;<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">login </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$login_error</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$username</span> = <span class="synIdentifier">$req-&gt;param</span>( <span class="synConstant">'username'</span> ) // <span class="synConstant">''</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">if</span> ( <span class="synIdentifier">$req-&gt;method</span> <span class="synStatement">eq</span> <span class="synConstant">'POST'</span> ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$user</span> = <span class="synIdentifier">$self-&gt;model-&gt;resultset</span>(<span class="synConstant">'Users'</span>)-&gt;find({ <span class="synConstant">username</span> =&gt; <span class="synIdentifier">$username</span> });<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">if</span> ( <span class="synIdentifier">$user</span> <span class="synStatement">and</span> <span class="synIdentifier">$user-&gt;check_passphrase</span>( <span class="synIdentifier">$req-&gt;param</span>( <span class="synConstant">'password'</span> ))) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$req-&gt;session-&gt;{</span><span class="synConstant">user_id</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$username</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$redir</span> = <span class="synStatement">delete</span> <span class="synIdentifier">$req-&gt;session-&gt;{</span><span class="synConstant">redir_to</span><span class="synIdentifier">}</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$redir</span> //= <span class="synConstant">'/'</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_throw( <span class="synConstant">Found</span> =&gt; { <span class="synConstant">location</span> =&gt; <span class="synIdentifier">$redir</span> });<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">else</span> { <span class="synIdentifier">$login_error</span> = <span class="synConstant">'Wrong user or password'</span> }<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$self-&gt;render</span>(<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'login.tx'</span> , {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">error</span>    =&gt; <span class="synIdentifier">$login_error</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">title</span>    =&gt; <span class="synConstant">'Login'</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">username</span> =&gt; <span class="synIdentifier">$username</span><br />&nbsp;&nbsp;&nbsp;&nbsp;});<br />}<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">logout </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">delete</span> <span class="synIdentifier">$req-&gt;session-&gt;{</span><span class="synConstant">user_id</span><span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">if</span> ( <span class="synIdentifier">$req-&gt;method</span> <span class="synStatement">eq</span> <span class="synConstant">'POST'</span> );<br /><br />&nbsp;&nbsp;http_throw( <span class="synConstant">SeeOther</span> =&gt; { <span class="synConstant">location</span> =&gt; <span class="synConstant">'/'</span> });<br />}<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>Here we have a fairly standard <code>login</code> method. If it&#39;s accessed via a GET request, it displays a login form (see below for the template). In response to a POST request, it looks for a user with the provided username, and, if one is found, checks the provided password against the stored one (using the <code>check_passphrase</code> helper method we get from <a href="https://metacpan.org/module/DBIx::Class::PassphraseColumn">PassphraseColumn</a>), and if it matches, saves the username in the session and issues a redirect to the stored redirection location. If any of those steps fails -- we didn&#39;t get a username, we can&#39;t find a user that corresponds to that username, or if the <code>check_passphrase</code> method returns false -- we&#39;ll redisplay the login form (with the previously-provided username filled back in, if we can).</p>

<p>Similarly, the <code>logout</code> method removes the logged-user, but only in response to a POST request.</p>

<p>Here&#39;s the template for the login form:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synComment">&lt;!DOCTYPE html&gt;</span><br /><span class="synIdentifier">&lt;</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span><br /><span class="synPreProc">    </span><span class="synIdentifier">&lt;</span><span class="synStatement">title</span><span class="synIdentifier">&gt;&lt;: $title :&gt;&lt;/</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span><br /><span class="synPreProc">  </span><span class="synIdentifier">&lt;/</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>OXauth <span class="synIdentifier">&lt;: $title :&gt;&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span><br /><br />: if( $error ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;&lt;</span><span class="synStatement">span</span><span class="synIdentifier"> </span><span class="synType">style</span><span class="synIdentifier">=</span><span class="synConstant">&quot;background: red; border: 1px solid black; padding: 5px&quot;</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;: $error :&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">span</span><span class="synIdentifier">&gt;&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span><br />: }<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">form</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">&quot;login_form&quot;</span><span class="synIdentifier"> </span><span class="synType">method</span><span class="synIdentifier">=</span><span class="synConstant">&quot;post&quot;</span><span class="synIdentifier"> &gt;</span> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">fieldset</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;main_fieldset&quot;</span><span class="synIdentifier">&gt;</span> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">label</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;label&quot;</span><span class="synIdentifier"> </span><span class="synType">for</span><span class="synIdentifier">=</span><span class="synConstant">&quot;username&quot;</span><span class="synIdentifier">&gt;</span>Username: <span class="synIdentifier">&lt;/</span><span class="synStatement">label</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">input</span><span class="synIdentifier"> </span><span class="synType">type</span><span class="synIdentifier">=</span><span class="synConstant">&quot;text&quot;</span><span class="synIdentifier"> </span><span class="synType">name</span><span class="synIdentifier">=</span><span class="synConstant">&quot;username&quot;</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">&quot;username&quot;</span><span class="synIdentifier"> </span><span class="synType">value</span><span class="synIdentifier">=</span><span class="synConstant">&quot;&lt;: $username :&gt;&quot;</span><span class="synIdentifier"> /&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">label</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;label&quot;</span><span class="synIdentifier"> </span><span class="synType">for</span><span class="synIdentifier">=</span><span class="synConstant">&quot;password&quot;</span><span class="synIdentifier">&gt;</span>Password: <span class="synIdentifier">&lt;/</span><span class="synStatement">label</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">input</span><span class="synIdentifier"> </span><span class="synType">type</span><span class="synIdentifier">=</span><span class="synConstant">&quot;password&quot;</span><span class="synIdentifier"> </span><span class="synType">name</span><span class="synIdentifier">=</span><span class="synConstant">&quot;password&quot;</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">&quot;password&quot;</span><span class="synIdentifier"> </span><span class="synType">value</span><span class="synIdentifier">=</span><span class="synConstant">&quot;&quot;</span><span class="synIdentifier"> /&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">input</span><span class="synIdentifier"> </span><span class="synType">type</span><span class="synIdentifier">=</span><span class="synConstant">&quot;submit&quot;</span><span class="synIdentifier"> </span><span class="synType">name</span><span class="synIdentifier">=</span><span class="synConstant">&quot;submit&quot;</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">&quot;submit&quot;</span><span class="synIdentifier"> </span><span class="synType">value</span><span class="synIdentifier">=</span><span class="synConstant">&quot;Login&quot;</span><span class="synIdentifier"> /&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">fieldset</span><span class="synIdentifier">&gt;</span> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">form</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span><br /><span class="synIdentifier">&lt;/</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span></code><br />&nbsp;</td></table>

<p>(See the documentation for the excellent <a href="https://metacpan.org/module/Text::Xslate">Text::Xslate</a> if you&#39;re curious about the non-HTML parts of that template.)</p>

<h2 id="Reuse-Is-Made-Of-Roles">Reuse Is Made Of Roles</h2>

<p>Since we&#39;re eventually going to have a number of controllers and methods that need to tell whether we have a logged-in user, and what permissions that user has, we&#39;ll implement the methods for checking those in a role that can be composed into whatever controllers need it. Here&#39;s a basic role that does that:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXauth::Role::Auth</span>;<br /><span class="synStatement">use </span>Moose::Role;<br /><br /><span class="synStatement">use </span>HTTP::Throwable::Factory <span class="synConstant">qw/ http_throw /</span>;<br /><br />requires <span class="synConstant">'load_user_from_session'</span>;<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">needs_auth </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> , <span class="synIdentifier">$redir</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synStatement">if</span> <span class="synIdentifier">$req-&gt;session-&gt;{</span><span class="synConstant">user_id</span><span class="synIdentifier">}</span>;<br /><br />&nbsp;&nbsp;<span class="synIdentifier">$req-&gt;session-&gt;{</span><span class="synConstant">redir_to</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$redir</span> || <span class="synConstant">'/'</span> ;<br />&nbsp;&nbsp;http_throw( <span class="synConstant">Found</span> =&gt; { <span class="synConstant">location</span> =&gt; <span class="synConstant">'/login'</span> });<br />}<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">needs_perm </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> , <span class="synIdentifier">$perm</span> , <span class="synIdentifier">$redir</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;needs_auth</span>( <span class="synIdentifier">$req</span> , <span class="synIdentifier">$redir</span> );<br /><br />&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$user</span> = <span class="synIdentifier">$self-&gt;load_user_from_session</span>( <span class="synIdentifier">$req-&gt;session</span> );<br /><br />&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synStatement">if</span> <span class="synIdentifier">$user-&gt;has_permission_to</span>( <span class="synIdentifier">$perm</span> );<br /><br />&nbsp;&nbsp;http_throw( <span class="synConstant">Found</span> =&gt; { <span class="synConstant">location</span> =&gt; <span class="synConstant">'/denied'</span> });<br />}<br /><br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>Note that in both cases, the methods simply return if the user is authenticated, or has the required permission. If that isn&#39;t the case, the methods throw <code>HTTP::Throwable</code> exceptions that result in redirects, either to the page with the login form, or to page that gives a &#39;Permission denied&#39; error message.</p>

<p>Also note that we&#39;re finally making use of that <code>has_permission_to</code> method that we defined back at the beginning of the article.</p>

<h2 id="Authentication-In-Action">Authentication In Action</h2>

<p>This authentication role can be used in a controller like so:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXauth::Controller::Admin</span>;<br /><span class="synStatement">use </span>Moose;<br />extends <span class="synConstant">'OXauth::Controller'</span>;<br />with <span class="synConstant">'OXauth::Role::Auth'</span>;<br /><br />has <span class="synConstant">'+title'</span> =&gt; ( <span class="synConstant">default</span> =&gt; <span class="synConstant">'Admin'</span> );<br /><br />around <span class="synConstant">'index'</span> =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$orig</span> , <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;needs_perm</span>( <span class="synIdentifier">$req</span> , <span class="synConstant">'admin'</span> , <span class="synIdentifier">$req-&gt;uri_for</span>( <span class="synIdentifier">$req-&gt;mapping</span> ) );<br /><br />&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;$orig</span>( <span class="synIdentifier">$req</span> );<br />};<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>And here&#39;s the base controller that <code>OXauth::Controller::Admin</code> is based on, which provides the <code>title</code> attribute and <code>index</code> method that the <code>Admin</code> controller is extending:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXauth::Controller</span>;<br /><span class="synComment"># ABSTRACT: OXauth Base controller</span><br /><span class="synStatement">use </span>Moose;<br /><span class="synStatement">use </span><span class="synConstant">5.010</span>;<br /><br />has <span class="synConstant">title</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>  =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span><br />);<br /><br />has <span class="synConstant">model</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>       =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>      =&gt; <span class="synConstant">'OXauth::Schema'</span>,<br />&nbsp;&nbsp;<span class="synConstant">handles</span>  =&gt; [ <span class="synConstant">qw/ load_user_from_session /</span> ] ,<br />&nbsp;&nbsp;<span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br />has <span class="synConstant">view</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>       =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>      =&gt; <span class="synConstant">'Text::Xslate'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">handles</span>  =&gt; [ <span class="synConstant">qw/ render /</span> ] ,<br />&nbsp;&nbsp;<span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">index </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$self-&gt;render</span>( <span class="synConstant">'index.tx'</span> , {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">title</span> =&gt; <span class="synIdentifier">$self-&gt;title</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">user</span>  =&gt; <span class="synIdentifier">$req-&gt;session-&gt;{</span><span class="synConstant">user_id</span><span class="synIdentifier">}</span> ,<br />&nbsp;&nbsp;});<br />}<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>Some things to note about the authentication role and the controllers:</p>

<ul>

<li><p>Because these are just normal Moose classes, we can trivially use a method modifier in the subclass to add a requirement for a user with a particular set of permissions. The <code>needs_perm</code> method will throw an exception if there isn&#39;t a logged-in user, or if the user doesn&#39;t have the right permission set, so our flow control remains simple.</p>

</li>
<li><p>We require the <code>view</code> and <code>model</code> attributes of <code>OXauth::Controller</code> so that we can use the <code>infer</code> option in our <a href="https://metacpan.org/module/OX">OX</a> application class (instead of supplying explicit deps).</p>

</li>
<li><p>Rather than hardcoding a URL as the third parameter to the <code>needs_perm</code> method, we use the <code>uri_for</code> and <code>mapping</code> methods of the <a href="https://metacpan.org/module/OX::Request">OX::Request</a> object we&#39;re passed to effectively say, &quot;Send us back to the same URL we&#39;re at now&quot;. (Exploiting the ability to do this to turn this role into an even-more generic service is left as an exercise for the reader.)</p>

</li>
</ul>

<h2 id="Putting-It-All-Together">Putting It All Together</h2>

<p>If you check out the <a href="https://github.com/genehack/oxauth">repository</a> and install any dependencies you&#39;re missing (which can do by running <code>cpanm Dist::Zilla &amp;&amp; dzil listdeps | cpanm</code> from the root of the checked-out repository), you can generate a test SQLite database with the <code>bin/deploy</code> script. Once that&#39;s done, you can run the app via the standard <code>plackup app.psgi</code> invocation. Navigate to <code>http://localhost:5000/</code> and select the &quot;Admin&quot; link, and you will be sent to a standard login form. Provide one of the username/password combinations you&#39;ll find in the <code>bin/deploy</code> script, and you should be redirected appropriately -- to <code>/admin</code> if the user you selected has the &quot;admin&quot; permission, or to <code>/denied</code> if the user does not (or, perhaps, back to the login form with an error message if you made a typo).</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/89415c88230cf6205f7518a6264c9aae?r=g&s=80&d=retro />
This article contributed by: John SJ Anderson &lt;john.anderson@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Custom Route Builders" href="2012-12-17.html">Previous</a></li>

    <li class="next"><a title="Under the Hood" href="2012-12-19.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





