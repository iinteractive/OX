<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.111" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
Options For Simple Authentication

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">2012 
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Options For Simple Authentication</h1>
<div class='subtitle'>OX - 2012-12-15</div>

<div class='pod'><h2 id="Selective-Sharing">Selective Sharing</h2>

<p>As we&#39;ve seen, one of the nice things about the OX framework is how it exemplifies and amplifies the whipuptitude nature of Perl. It&#39;s easy to go from a wild idea to a single file proof-of-concept level implementation with OX, and then later refactor that prototype into your &quot;real&quot; application.</p>

<p>Personally, I find there&#39;s usually a point between &quot;prototype&quot; and &quot;alpha&quot; where I want to share my work with other people to get their feedback. That usually means putting it on an Internet-accessible server and mailing my collaborators the URL -- and that also means I need to put some sort of authentication wrapper around the prototype, so that the whole world can&#39;t see my work in progress.</p>

<p>One option is to wait to share your prototype until you&#39;ve gotten to the point of implementing the required amount of authentication in the application itself. This may be a ways down the road, however, and it&#39;s hard to wait to share. Another option is to put some HTTP Basic-style authentication in place via Apache <code>.htaccess</code> files, but that requires some sysadmin style tinkering with htpasswd files and probably with your web server configuration.</p>

<p>Since OX builds upon Plack/PSGI, a more attractive alternative is to leverage existing Plack middleware to add authentication directly to the prototype application. We can add either HTTP Basic style authentication, or a full-blown form-based login. Let&#39;s see what each of those looks like.</p>

<h2 id="Plack::Middleware::Auth::Basic">Plack::Middleware::Auth::Basic</h2>

<p><a href="https://metacpan.org/module/Plack::Middleware::Auth::Basic">Plack::Middleware::Auth::Basic</a>, as you might guess from the module name, is a middleware that implements basic types of authentication for your application. The module takes an <code>authenticator</code> configuration option, which can be an object that implements an <code>authenticate</code> method (with a <code>($username,$password)</code> signature) or a simple callback function, which will also be called with the username and password provided in response to the authentication dialogue. This means an OX application implementing basic authentication can be as simple as:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> MyOXsomeApp</span>;<br /><span class="synStatement">use </span>OX;<br /><br />router as {<br />&nbsp;&nbsp;wrap <span class="synConstant">'Plack::Middleware::Auth::Basic'</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">authenticator</span> =&gt; literal( <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$user</span>, <span class="synIdentifier">$pass</span> ) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$user</span> <span class="synStatement">eq</span> <span class="synConstant">'s00per'</span> <span class="synStatement">and</span> <span class="synIdentifier">$pass</span> <span class="synStatement">eq</span> <span class="synConstant">'s3kr1t'</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;} ),<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">realm</span> =&gt; literal( <span class="synConstant">&quot;my awesome app!&quot;</span> ),<br />&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;route <span class="synConstant">'/'</span> =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;hello world!&quot;</span> };<br />};</code><br />&nbsp;</td></table>

<p>The <code>realm</code> option being passed to the middleware is used to control what is displayed in the pop-up window that appears when the web browser prompts for credentials. Since <code>wrap</code> stanzas in the <code>router</code> statement do the same sort of <code>Bread::Board</code>-based service resolution as other parts of <code>OX</code>, you could also use attributes for the <a href="https://metacpan.org/module/Plack::Middleware::Auth::Basic">Plack::Middleware::Auth::Basic</a> parameters, like so:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> MyOXsomeApp</span>;<br /><span class="synStatement">use </span>OX;<br /><br />has <span class="synConstant">basic_auth_realm</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">is</span>    =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">isa</span>   =&gt; <span class="synConstant">'Str'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">value</span> =&gt; <span class="synConstant">'My Awesome App!'</span><br />);<br /><br />router as {<br />&nbsp;&nbsp;wrap <span class="synConstant">'Plack::Middleware::Auth::Basic'</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">authenticator</span> =&gt; literal( <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> ( <span class="synIdentifier">$user</span> , <span class="synIdentifier">$pass</span> ) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$user</span> <span class="synStatement">eq</span> <span class="synConstant">'s00per'</span> <span class="synStatement">and</span> <span class="synIdentifier">$pass</span> <span class="synStatement">eq</span> <span class="synConstant">'s3kr1t'</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;} ),<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">realm</span> =&gt; <span class="synConstant">'basic_auth_realm'</span>,<br />&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;route <span class="synConstant">'/'</span> =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;hello world!&quot;</span> };<br />};</code><br />&nbsp;</td></table>

(Note: you can download this application
<a href="basic.psgi">here</a>.)

<h2 id="Plack::Middleware::Auth::Form">Plack::Middleware::Auth::Form</h2>

<p>HTTP Basic-style authentication is great when you need a quick way to secure access to an entire application. However, if you&#39;re trying to prototype an application that will have some areas that require authentication and some that don&#39;t, it may not be the best choice. Instead, consider <a href="https://metacpan.org/module/Plack::Middleware::Auth::Form">Plack::Middleware::Auth::Form</a>, which adds <code>/login</code> and <code>/logout</code> endpoints to your application. You&#39;ll also want to load <a href="https://metacpan.org/module/Plack::Middleware::Session">Plack::Middleware::Session</a> to provide a way to store details such as the username of the current user. <code>Plack::Middleware::Auth::Form</code> is configured very similarly to <code>Plack::Middleware::Auth::Basic</code> -- the required <code>authenticator</code> option works exactly as described above, in fact.</p>

<p>Here&#39;s a simple OX application that uses form-based authentication to control access to the <code>/admin</code> endpoint, while allowing unauthenticated access for <code>/</code>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> MyOXsomeApp</span>;<br /><span class="synStatement">use </span>OX;<br /><br /><span class="synStatement">use </span>HTTP::Throwable::Factory <span class="synConstant">qw/ http_throw /</span>;<br /><br />router as {<br />&nbsp;&nbsp;wrap <span class="synConstant">'Plack::Middleware::Session'</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">store</span> =&gt; literal( <span class="synConstant">'File'</span> ),<br />&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;wrap <span class="synConstant">'Plack::Middleware::Auth::Form'</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">authenticator</span> =&gt; literal( <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> ( <span class="synIdentifier">$user</span>, <span class="synIdentifier">$pass</span> ) = <span class="synIdentifier">@_</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$user</span> <span class="synStatement">eq</span> <span class="synConstant">'s00per'</span> <span class="synStatement">and</span> <span class="synIdentifier">$pass</span> <span class="synStatement">eq</span> <span class="synConstant">'s3kr1t'</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;} ),<br />&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;route <span class="synConstant">'/'</span> =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;hello world!&quot;</span> };<br /><br />&nbsp;&nbsp;route <span class="synConstant">'/admin'</span> =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> ( <span class="synIdentifier">$request</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$user</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">unless</span> ( <span class="synIdentifier">$user</span> = <span class="synIdentifier">$request-&gt;session-&gt;{</span><span class="synConstant">user_id</span><span class="synIdentifier">}</span> ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$request-&gt;session-&gt;{</span><span class="synConstant">redir_to</span><span class="synIdentifier">}</span> = <span class="synConstant">'/admin'</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_throw( <span class="synConstant">Found</span> =&gt; { <span class="synConstant">location</span> =&gt; <span class="synConstant">'/login'</span> } );<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synConstant">&quot;admin section!&lt;br/&gt;hello </span><span class="synIdentifier">$user</span><span class="synConstant">!&quot;</span>;<br />&nbsp;&nbsp;};<br />};</code><br />&nbsp;</td></table>

(Note: you can download this application
<a href="form.psgi">here</a>.)

<p>Here we have the same <code>authenticator</code> callback as in the previous example, but we&#39;re using <a href="https://metacpan.org/module/Plack::Middleware::Auth::Form">Plack::Middleware::Auth::Form</a> instead. You should be able to load the <code>/</code> endpoint without being prompted for a password, but attempting to load <code>/admin</code> should result in you being redirected to <code>/login</code>, which will display a simple login form.</p>

<p>Looking at the inline sub for the <code>/admin</code> route, we see that we&#39;re looking at the PSGI session hash (available via the <code>session</code> method on the <code>$request</code> object that is passed to the action) to see if there&#39;s a <code>user_id</code> key. If there is, that means we have a logged-in user, and can fall past the conditional and return a string to display. If we don&#39;t see a value in this key, however, that means we don&#39;t have a logged in user, and we want to display the login form instead. We can easily accomplish this by throwing a <a href="https://metacpan.org/module/HTTP::Throwable">HTTP::Throwable</a> exception, as described in Monday&#39;s article.</p>

<p>(<i>N.B.</i>, if you were implementing this type of authentication in a real application, you&#39;d want to either wrap up the code that checks for an active user and issues a redirect to <code>/login</code> inside a role that could be consumed by controller modules that needed this functionality, or implement the logic as a middleware.)</p>

<h2 id="Next-steps">Next steps</h2>

<p>When you&#39;re ready to move beyond the &quot;prototype&quot; stage of your application, you&#39;ll find yourself wanting to authenticate against information you&#39;ve got stored in a database (or another type of data store that you&#39;ve abstracted behind a model-layer module). You&#39;ll also want a login form that fits into the look-and-feel of the rest of your site, ideally one that renders and validates input via the same modules as the rest of your view layer. At that point, you&#39;ll probably want to drop <a href="https://metacpan.org/module/Plack::Middleware::Auth::Form">Plack::Middleware::Auth::Form</a> in favor of your own code. We&#39;ll leave that step as an exercise for the reader (at least for the moment...)</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/89415c88230cf6205f7518a6264c9aae?r=g&s=80&d=retro />
This article contributed by: John SJ Anderson &lt;john.anderson@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="More Bread::Board" href="2012-12-14.html">Previous</a></li>

    <li class="next"><a title="Configuration with OX" href="2012-12-16.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





