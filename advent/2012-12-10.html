<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.108" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
Exceptions

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">
          <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Exceptions</h1>
<div class='subtitle'>OX - 2012-12-10</div>

<div class='pod'><h2 id="Exception-handling">Exception handling</h2>

<p>OX applications are implicitly wrapped in the <a href="https://metacpan.org/module/Plack::Middleware::HTTPExceptions">Plack::Middleware::HTTPExceptions</a> middleware. This allows you to throw exception objects which implement various methods describing an HTTP error or redirect response, and have that exception object translated into a real PSGI response.</p>

<p>Your exception objects can either implement the <code>as_psgi</code> method (which will return a PSGI response to be used directly), or they can implement a <code>code</code> method (and optionally <code>as_string</code> and <code>location</code>), and a response will be built from calling those methods. Two common CPAN modules which implement a compatible interface are <a href="https://metacpan.org/module/HTTP::Exception">HTTP::Exception</a> and <a href="https://metacpan.org/module/HTTP::Throwable">HTTP::Throwable</a>. Since HTTP::Throwable is more flexible and extensible (being built via a set of reusable Moose roles), it is generally recommended for this purpose.</p>

<h2 id="HTTP::Throwable">HTTP::Throwable</h2>

<p>HTTP::Throwable implements a set of exception classes for HTTP redirect and error codes (3xx, 4xx, 5xx). HTTP::Throwable itself is a role which provides functionality common to all of the classes, but you typically interact with it via <a href="https://metacpan.org/module/HTTP::Throwable::Factory">HTTP::Throwable::Factory</a>, which provides shortcuts for creating and throwing HTTP::Throwable objects. For instance:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">use </span>HTTP::Throwable::Factory <span class="synConstant">'http_throw'</span>;<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">index </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$r</span>) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;http_throw(<span class="synConstant">MethodNotAllowed</span> =&gt; { <span class="synConstant">allow</span> =&gt; [ <span class="synConstant">qw(GET)</span> ] })<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">unless</span> <span class="synIdentifier">$r-&gt;method</span> <span class="synStatement">eq</span> <span class="synConstant">'GET'</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;http_throw(<span class="synConstant">Found</span> =&gt; { <span class="synConstant">location</span> =&gt; <span class="synIdentifier">$r-&gt;uri_for</span>(<span class="synConstant">'login'</span>) })<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">unless</span> <span class="synStatement">exists</span> <span class="synIdentifier">$r-&gt;session-&gt;{</span><span class="synConstant">user_id</span><span class="synIdentifier">}</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synComment"># ...</span><br />}</code><br />&nbsp;</td></table>

<p>http_throw takes the name of an exception type and an optional hashref of parameters for the exception class&#39;s constructor. The exception class used will consume the role <code>HTTP::Throwable::Role::Status::$type</code>, so you can find the documentation for specific HTTP statuses in the documentation for the individual status roles. If you just want to create the exception object to throw later, you can use the <code>http_exception</code> function instead, which works identically except that the exception object is returned instead of thrown.</p>

<h2 id="Caveats">Caveats</h2>

<p>While using exceptions in this way can save a lot of code (you don&#39;t have to worry about missing an input failing to pass validation, for instance), there are also a few things to keep in mind.</p>

<ul>

<li><p>Exceptions for exceptional conditions</p>

<p>Plack::Middleware::HTTPExceptions and HTTP::Throwable only support 3xx, 4xx, and 5xx HTTP status codes. This is intentional, because using exceptions as a generic flow control mechanism is bad practice, and tends to make your code more difficult to follow. Exceptions should be used for exceptional conditions, such as validation or authorization failures. Real responses to requests in your application should use a normal code flow.</p>

</li>
<li><p>Middleware</p>

<p>OX&#39;s automatic use of Plack::Middleware::Exceptions happens at the innermost layer, which means that exceptions thrown from middleware will not be handled. This is because skipping over middleware stack frames via exceptions can lead to very confusing bugs. Middleware are typically written to expect to be able to run code after a request returns, and exceptions defeat this.</p>

<p>For instance, take the example of <a href="https://metacpan.org/module/Plack::Middleware::Session">Plack::Middleware::Session</a>. It needs to be able to save the session data back to the session store when the request ends so that it will be there for next time. If you modify the session data but then end the request via <code>http_throw</code>, that exception needs to be caught before the exception unwinds the Plack::Middleware::Session stack frame, or else the modified session data will not be saved.</p>

</li>
</ul>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/615c9501f43cca57a2467232c5257544?r=g&s=80&d=retro />
This article contributed by: Jesse Luehrs &lt;jesse.luehrs@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="uri_for" href="2012-12-09.html">Previous</a></li>

    <li class="next"><a title="Deployment" href="2012-12-11.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>
    </div>
</body>
</html>



