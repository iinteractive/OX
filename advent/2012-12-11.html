<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.111" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
Deployment

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">2012 
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Deployment</h1>
<div class='subtitle'>OX - 2012-12-11</div>

<div class='pod'><h2 id="Plack">Plack</h2>

<p>OX interacts with web servers entirely via PSGI. This means that you can use any of the tools provided by <a href="https://metacpan.org/module/Plack">Plack</a> to manage and deploy your OX applications. Plack provides functionality to run your app on many different application servers, tools to manage your application during development and deployment, and several middleware classes to fix deployment issues in various situations.</p>

<h3 id="app.psgi-and-plackup"><code>app.psgi</code> and <code>plackup</code></h3>

<p>Plack&#39;s tools typically interact with applications via <code>.psgi</code> files. This is a file which, when evaluated, returns a PSGI application coderef. As mentioned previously, an OX application as typically written is a valid <code>.psgi</code> file:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synComment"># app.psgi</span><br /><span class="synStatement">use </span>OX;<br /><br />router as {<br />&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/'</span> =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;Hello world!&quot;</span> };<br />};</code><br />&nbsp;</td></table>

<p>but this quickly becomes unwieldy. Splitting your application into multiple packages and files is important not only for code organization, but also because having a split between code that is inherent to your application and code that is specific to deployment makes the deployment process much easier. For instance, if your application uses sessions, the <a href="https://metacpan.org/module/Plack::Middleware::Session">Session</a> middleware is conceptually part of the application itself - running the application without that middleware applied doesn&#39;t make a lot of sense. On the other hand, the <a href="https://metacpan.org/module/Plack::Middleware::ReverseProxy">ReverseProxy</a> middleware is dependent on your deployment environment - declaring that in your application doesn&#39;t make sense because you might run your same application in several different environments, only some of which use a reverse proxy.</p>

<p>The typical way that OX applications are written is to write them as a class:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synComment"># Hello.pm</span><br /><span class="synStatement">package</span><span class="synType"> Hello</span>;<br /><span class="synStatement">use </span>OX;<br /><br />router as {<br />&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/'</span> =&gt; <span class="synStatement">sub </span>{ <span class="synConstant">&quot;Hello world!&quot;</span> };<br />};<br /><br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>and then write an <code>app.psgi</code> file which instantiates the application:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synComment"># app.psgi</span><br /><span class="synStatement">use </span>Hello;<br />Hello-&gt;new-&gt;to_app;</code><br />&nbsp;</td></table>

<p>This way, you can easily add additional deployment-specific code to just the <code>app.psgi</code> file, to do whatever you need to do:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synComment"># app.psgi</span><br /><span class="synStatement">use </span>Hello;<br /><span class="synStatement">use </span>Plack::Middleware::ReverseProxy;<br /><br /><span class="synStatement">my</span> <span class="synIdentifier">$app</span> = Hello-&gt;new-&gt;to_app;<br /><span class="synIdentifier">$app</span> = Plack::Middleware::ReverseProxy-&gt;wrap(<span class="synIdentifier">$app</span>);<br /><br /><span class="synIdentifier">$app</span>;</code><br />&nbsp;</td></table>

<p><a href="https://metacpan.org/module/Plack::Builder">Plack::Builder</a> can also be helpful for this.</p>

<h2 id="Servers">Servers</h2>

<p>Now that we have an <code>app.psgi</code> file, we can run the application in any application server supported by <a href="https://metacpan.org/module/Plack::Loader">Plack::Loader</a>. By default, if you just run <code>plackup</code>, it will run your application using <a href="https://metacpan.org/module/HTTP::Server::PSGI">HTTP::Server::PSGI</a>. This is a simple, single-process server which can be used during development. For your actual deployment, however, you&#39;ll likely want to use a more fully-featured server.</p>

<p>By passing the <code>-s</code> option to <code>plackup</code>, you can use any application server which has a corresponding <a href="https://metacpan.org/module/Plack::Handler">Plack::Handler</a> class. <a href="https://metacpan.org/module/Starman">Starman</a> is a good example of a production-ready application server. It is fast, preforking, and supports all of HTTP/1.1. A typical Starman deployment involves running your application with starman as a normal user on a port that isn&#39;t exposed to the public, and then running a reverse proxy of some sort in front of it. This ensures that you don&#39;t need to run your application itself as root, and also prevents attacks like <a href="http://en.wikipedia.org/wiki/Slowloris">Slowloris</a>, which Starman on its own would otherwise be vulnerable to.</p>

<p>To run Starman, you can pass <code>-s Starman</code> to your <code>plackup</code> invocation, or you can use the <code>starman</code> runner script instead (which has more configuration options available). You should also add the ReverseProxy middleware to your <code>app.psgi</code> file (to ensure that your application sees the correct values for the <code>host</code>). For the reverse proxy itself, something like <a href="http://www.nginx.org/">nginx</a> works well, using a configuration like this:</p>

<pre><code>  server {
      listen 80;
      server_name myapp.example.com;

      location / {
          proxy_set_header Host               $http_host;
          proxy_set_header X-Forwarded-Host   $http_host;
          proxy_set_header X-Real-IP          $remote_addr;
          proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Port   80;

          proxy_pass http://localhost:5000/;
      }
  }</code></pre>

<p>You should adjust the port in the proxy_pass statement to point to the port that you have Starman running on.</p>

<h2 id="Further-reading">Further reading</h2>

<p>If you need to deploy via other application servers or proxies, the Plack documentation covers a great deal of this. All of the server-specific documentation is covered in the <a href="https://metacpan.org/module/Plack::Handler">Plack::Handler</a> classes (like <a href="https://metacpan.org/module/Plack::Handler::FCGI">Plack::Handler::FCGI</a>, <a href="https://metacpan.org/module/Plack::Handler::Apache2">Plack::Handler::Apache2</a>, etc). In addition, the <a href="http://advent.plackperl.org/">Plack advent calendar</a> contains a lot of useful tips and tricks.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/615c9501f43cca57a2467232c5257544?r=g&s=80&d=retro />
This article contributed by: Jesse Luehrs &lt;jesse.luehrs@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Exceptions" href="2012-12-10.html">Previous</a></li>

    <li class="next"><a title="Back To Basics" href="2012-12-12.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





