<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.108" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
Custom Route Builders

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">
          <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Custom Route Builders</h1>
<div class='subtitle'>OX - 2012-12-17</div>

<div class='pod'><h2 id="Route-builders">Route builders</h2>

<p>As mentioned previously, route builders handle parsing the action spec to determine what code to run when a route is matched. Although OX comes with some default route builders, you can also write your own to handle other kinds of action specs.</p>

<p><b>A note beforehand:</b> this API is a lot less finalized and more experimental than many of the other parts discussed so far, and may change in the future. It is a useful piece of functionality however, and still worth discussing even if the details may change later.</p>

<h3 id="OX::RouteBuilder">OX::RouteBuilder</h3>

<p>A route builder is implemented via a class which consumes the <a href="https://metacpan.org/module/OX::RouteBuilder">OX::RouteBuilder</a> role. This role requires two methods:</p>

<ul>

<li><p><code>parse_action_spec</code></p>

<p>This is a class method which is called when OX attempts to parse an action spec. If the action spec should be handled by this route builder, this method should return a value containing the parsed data (to be used later). Otherwise, it should return <code>undef</code>. OX will call the <code>parse_action_spec</code> method on all enabled route builders to find the one that doesn&#39;t return <code>undef</code>, and that one will be instantiated with the route data.</p>

</li>
<li><p><code>compile_routes</code></p>

<p>This method is called on the instantiated route builder, and is used to turn the route description into actual route data. You can access the route data via the <code>path</code>, <code>route_spec</code>, and <code>params</code> attributes. <code>path</code> is the path given as the first argument of the <code>route</code> statement, <code>route_spec</code> is the value that <code>parse_action_spec</code> returned, and <code>params</code> is a hashref of the parameters given at the end of the route statement. The parameters can be split into defaults and validations by calling the <code>extract_defaults_and_validations</code> method. The <code>compile_routes</code> method should return a hashref containing keys for <code>path</code>, <code>target</code>, <code>defaults</code>, and <code>validations</code>.</p>

</li>
</ul>

<p>This is perhaps more clear with an example. Here is a route builder which parses action specs of the form:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">GET</span>  =&gt; <span class="synStatement">sub </span>{ ... },<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">POST</span> =&gt; <span class="synStatement">sub </span>{ ... },<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'*'</span>  =&gt; <span class="synStatement">sub </span>{ ... },<br />}</code><br />&nbsp;</td></table>

<p>In other words, a hashref mapping HTTP methods to code to run for those methods.</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> MyApp::RouteBuilder::HTTPMethodCode</span>;<br /><span class="synStatement">use </span>Moose;<br /><br />with <span class="synConstant">'OX::RouteBuilder'</span>;<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">parse_action_spec </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$class</span> = <span class="synStatement">shift</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$action_spec</span>) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synStatement">unless</span> <span class="synStatement">ref</span>(<span class="synIdentifier">$action_spec</span>) <span class="synStatement">eq</span> <span class="synConstant">'HASH'</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$action_spec</span>;<br />}<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">compile_routes </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> (<span class="synIdentifier">$defaults</span>, <span class="synIdentifier">$validations</span>) = <span class="synIdentifier">$self-&gt;extract_defaults_and_validations</span>(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;params</span><br />&nbsp;&nbsp;&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$actions</span> = <span class="synIdentifier">$self-&gt;route_spec</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$target</span> = <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$r</span> = <span class="synStatement">shift</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$actions-&gt;{$r-&gt;method}</span>-&gt;(<span class="synIdentifier">$r</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">if</span> <span class="synStatement">exists</span> <span class="synIdentifier">$actions-&gt;{$r-&gt;method}</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$actions-&gt;{</span><span class="synConstant">'*'</span><span class="synIdentifier">}</span>-&gt;(<span class="synIdentifier">$r</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">if</span> <span class="synStatement">exists</span> <span class="synIdentifier">$actions-&gt;{</span><span class="synConstant">'*'</span><span class="synIdentifier">}</span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">@allowed</span> = <span class="synStatement">exists</span> <span class="synIdentifier">$actions-&gt;{</span><span class="synConstant">'*'</span><span class="synIdentifier">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? (<span class="synConstant">qw(OPTIONS GET HEAD POST PUT DELETE TRACE CONNECT)</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: (<span class="synStatement">keys</span> <span class="synIdentifier">%$actions</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">405</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'Content-Type'</span> =&gt; <span class="synConstant">'text/plain'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'Allow'</span>        =&gt; <span class="synStatement">join</span>(<span class="synConstant">&quot;,&quot;</span>, <span class="synIdentifier">@allowed</span>),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="synConstant">&quot;Method &quot;</span> . <span class="synIdentifier">$r-&gt;method</span> . <span class="synConstant">&quot; not allowed&quot;</span> ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;};<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">path</span>        =&gt; <span class="synIdentifier">$self-&gt;path</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">target</span>      =&gt; <span class="synIdentifier">$target</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">defaults</span>    =&gt; <span class="synIdentifier">$defaults</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">validations</span> =&gt; <span class="synIdentifier">$validations</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;};<br />}</code><br />&nbsp;</td></table>

<p>So going through this a piece at a time, we first have the <code>parse_action_spec</code> method. This will match any action spec which is a hashref, as in the case of a route that looks like</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>route <span class="synConstant">'/posts'</span> =&gt; { <span class="synConstant">GET</span> =&gt; <span class="synStatement">sub </span>{ ... }, <span class="synConstant">POST</span> =&gt; <span class="synStatement">sub </span>{ ... } };</code><br />&nbsp;</td></table>

<p>It returns the action spec as-is to be used later, since nothing about it needs to be parsed out.</p>

<p>Next, we have the <code>compile_routes</code> method. The first thing it does is extract the defaults and validations from the given params. Validations are params whose values are hashrefs with an <code>isa</code> key, and defaults are params whose values are strings. If you want to add any additional defaults, you can also do that at this point (adding a value for <code>name</code> is often a useful thing to do in cases where there is a natural default to use for it, since it will make using <code>uri_for</code> easier, as described in a previous article).</p>

<p>It then creates the target coderef. This is the code which will be called as the action for the route. It receives an <a href="https://metacpan.org/module/OX::Request">OX::Request</a> object as its only parameter, and returns some kind of response. Here, it looks at the request to see what HTTP method it was given, and sees if there is a corresponding action to use for it. If there is, it calls that action with the request object. If there isn&#39;t, it looks for a key of <code>&#39;*&#39;</code> as a fallback. If that doesn&#39;t exist either, it returns a valid <code>405 Method Not Allowed</code> error response.</p>

<p>Finally, it returns the hashref containing all of the data it has assembled.</p>

<h2 id="Using-custom-route-builders">Using custom route builders</h2>

<p>So now we have our custom route builder, but how do we use it? By default if nothing is specified, OX uses the <a href="https://metacpan.org/module/OX::RouteBuilder::Code">OX::RouteBuilder::Code</a>, <a href="https://metacpan.org/module/OX::RouteBuilder::ControllerAction">OX::RouteBuilder::ControllerAction</a>, and <a href="https://metacpan.org/module/OX::RouteBuilder::HTTPMethod">OX::RouteBuilder::HTTPMethod</a> route builders. To specify an alternate set of route builders to use, you provide them in an arrayref as the first argument to the <code>router</code> block:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>router [<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'OX::RouteBuilder::ControllerAction'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'MyApp::RouteBuilder::HTTPMethodCode'</span>,<br />] =&gt; as {<br />&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/'</span>      =&gt; <span class="synConstant">'root.index'</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/posts'</span> =&gt; { <span class="synConstant">GET</span> =&gt; <span class="synStatement">sub </span>{ ... }, <span class="synConstant">POST</span> =&gt; <span class="synStatement">sub </span>{ ... } };<br />};</code><br />&nbsp;</td></table>

<p>Note that this replaces the default list rather than appending to it. This way, you can provide your own interpretation of things that the default route builders would otherwise handle, without things getting confused.</p>

<h3 id="Nested-routers">Nested routers</h3>

<p>In the case of nested routers, the default set of route builders is taken from the enclosing router if nothing is specified, rather than always using the base default. For instance:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>router [<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'OX::RouteBuilder::ControllerAction'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">'MyApp::RouteBuilder::HTTPMethodCode'</span>,<br />] =&gt; as {<br />&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/'</span>      =&gt; <span class="synConstant">'root.index'</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;mount <span class="synConstant">'/posts'</span> =&gt; router as {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;route <span class="synConstant">'/'</span> =&gt; { <span class="synConstant">GET</span> =&gt; <span class="synStatement">sub </span>{ ... }, <span class="synConstant">POST</span> =&gt; <span class="synStatement">sub </span>{ ... } };<br />&nbsp;&nbsp;&nbsp;&nbsp;};<br />};</code><br />&nbsp;</td></table>

<p>Here, the second <code>route</code> statement works properly, because the router mounted at <code>/posts</code> uses the same list of route builders as its parent.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/615c9501f43cca57a2467232c5257544?r=g&s=80&d=retro />
This article contributed by: Jesse Luehrs &lt;jesse.luehrs@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Configuration with OX" href="2012-12-16.html">Previous</a></li>

    <li class="next">Next</li>
</ul>
<div style="clear: both"></div>

        </div>
    </div>
</body>
</html>



