<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.111" />
    <link rel="alternate" title="OX Advent Calendar XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>
OX Advent Calendar - 
A form2email gateway in OX

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">OX Advent Calendar</a></h1>
        </div>

        <p id="tagline">2012 
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>A form2email gateway in OX</h1>
<div class='subtitle'>OX - 2012-12-23</div>

<div class='pod'><h2 id="A-Friend-In-Need">A Friend In Need</h2>

<p>Recently, a friend asked me for a favor -- she needed to collect vendor registration information for a conference she was organizing. Her internal IT staff didn&#39;t have the resources to help her and none of the free options (such as Google Forms) would work. Thanks to <a href="https://metacpan.org/module/OX">OX</a> and a number of other CPAN modules, I was able to quickly throw something together to help my friend out.</p>

<p>While I can&#39;t share the exact application I built for my friend, I can walk you through the general outline of how I quickly combined <a href="https://metacpan.org/module/OX">OX</a>, <a href="https://metacpan.org/module/Text::Xslate">Text::Xslate</a>, <a href="https://metacpan.org/module/Data::Verifier">Data::Verifier</a>, <a href="http://twitter.github.com/bootstrap/">Bootstrap</a> and a few other Perl modules to solve this problem.</p>

<h2 id="Form-Goes-In-Email-Comes-Out">Form Goes In, Email Comes Out</h2>

<p>The form2email gateway -- a program that displays a web form and then emails the contents of that web form to a configured address -- is among the oldest types of CGI programs we have. Let&#39;s see what an OX version of one looks like.</p>

<p>(All the code discussed below is available from <a href="https://github.com/genehack/oxform2mail">this github repo</a>; install missing dependencies by running <code>cpanm Dist::Zilla &amp;&amp; dzil listdeps | cpanm</code>.)</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXform2email</span>;<br /><span class="synComment"># ABSTRACT: OX advent form2email example</span><br /><span class="synStatement">use </span>OX;<br /><span class="synStatement">use </span><span class="synConstant">5.016</span>;<br /><br />has <span class="synConstant">email_from</span>    =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">email_subject</span> =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">email_to</span>      =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br /><br />has <span class="synConstant">email_view</span> =&gt;(<br />&nbsp;&nbsp;<span class="synConstant">is</span>           =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>          =&gt; <span class="synConstant">'OXform2email::View::Email'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">dependencies</span> =&gt; [ <span class="synConstant">qw/ email_from email_subject email_to /</span> ] ,<br />);<br /><br />has <span class="synConstant">cache_dir</span>     =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">static_root</span>   =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">template_root</span> =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br /><br />has <span class="synConstant">html_view</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>           =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>          =&gt; <span class="synConstant">'OXform2email::View::HTML'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">dependencies</span> =&gt; [ <span class="synConstant">qw/ cache_dir template_root /</span> ] ,<br />);<br /><br />has <span class="synConstant">verifier_config</span> =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'HashRef'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br /><br />has <span class="synConstant">verifier</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>           =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>          =&gt; <span class="synConstant">'Data::Verifier'</span>,<br />&nbsp;&nbsp;<span class="synConstant">dependencies</span> =&gt; [ <span class="synConstant">'verifier_config'</span> ] ,<br />&nbsp;&nbsp;<span class="synConstant">block</span>        =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;Data::Verifier-&gt;new( <span class="synStatement">shift</span>-&gt;param( <span class="synConstant">'verifier_config'</span> ))<br />&nbsp;&nbsp;} ,<br />);<br /><br />has <span class="synConstant">controller</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>    =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>   =&gt; <span class="synConstant">'OXform2email::Controller'</span>,<br />&nbsp;&nbsp;<span class="synConstant">infer</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br />router as {<br />&nbsp;&nbsp;wrap <span class="synConstant">'Plack::Middleware::Static'</span> =&gt; (<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">root</span> =&gt; <span class="synConstant">'static_root'</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">path</span> =&gt; literal( <span class="synConstant">qr{^/</span><span class="synSpecial">(?:</span><span class="synConstant">css</span><span class="synSpecial">)</span><span class="synConstant">/}</span> ),<br />&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;route <span class="synConstant">'/'</span> =&gt; <span class="synConstant">'controller'</span> , ( <span class="synConstant">name</span> =&gt; <span class="synConstant">'index'</span> );<br />};<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>We have two view components -- an <code>email_view</code> and an <code>html_view</code> -- each of which has some required dependencies (these are supplied via the application config file). Additionally, we have an input validation component, in the form of a <a href="https://metacpan.org/module/Data::Verifier">Data::Verifier</a> instance, as well as a single controller.</p>

<p>From looking at the router block, you can see we&#39;re making use of the <a href="https://metacpan.org/module/OX::RouteBuilder::HTTPMethod">HTTPMethod</a> route builder (see <a href="http://iinteractive.github.com/OX/advent/2012-12-02.html">Jesse&#39;s earlier RouteBuilder article</a> if you need more details on RouteBuilders). We&#39;re also using <a href="https://metacpan.org/module/Plack::Middleware::Static">Plack::Middleware::Static</a>, just to serve a local copy of the Bootstrap CSS file.</p>

<h2 id="You-GET-Some-You-POST-Some">You GET Some, You POST Some</h2>

<p>Using the HTTPMethod route builder means that the controller needs to implement methods based on the HTTP verbs it wants to respond to. For our purposes, there are two: <code>get</code> -- which we&#39;ll respond to when displaying an initial, empty copy of our form -- and <code>post</code> -- which we&#39;ll respond to when the form is submitted. Here&#39;s our controller code:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXform2email::Controller</span>;<br /><span class="synStatement">use </span>Moose;<br /><br />has <span class="synConstant">email_view</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>       =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>      =&gt; <span class="synConstant">'OXform2email::View::Email'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> ,<br />&nbsp;&nbsp;<span class="synConstant">handles</span>  =&gt; [ <span class="synConstant">qw/ send_email /</span> ] ,<br />);<br /><br />has <span class="synConstant">html_view</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>       =&gt; <span class="synConstant">'ro'</span>,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>      =&gt; <span class="synConstant">'OXform2email::View::HTML'</span>,<br />&nbsp;&nbsp;<span class="synConstant">handles</span>  =&gt; [ <span class="synConstant">qw/ render /</span> ] ,<br />&nbsp;&nbsp;<span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br />has <span class="synConstant">verifier</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>       =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>      =&gt; <span class="synConstant">'Data::Verifier'</span>,<br />&nbsp;&nbsp;<span class="synConstant">handles</span>  =&gt; [ <span class="synConstant">qw/ verify /</span> ] ,<br />&nbsp;&nbsp;<span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> ,<br />);<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">get </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synComment"># a GET means that we need to show a blank form...</span><br />&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;render</span>( <span class="synIdentifier">$req</span> , <span class="synConstant">'index'</span> );<br />}<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">post </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$req</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synComment"># a POST means we need to process a submission and either show the thanks</span><br />&nbsp;&nbsp;<span class="synComment"># page or redisplay the form</span><br /><br />&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$results</span> = <span class="synIdentifier">$self-&gt;verify</span>( <span class="synIdentifier">$req-&gt;parameters</span> );<br /><br />&nbsp;&nbsp;<span class="synStatement">if</span> ( <span class="synIdentifier">$results-&gt;success</span> ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;send_email</span>({ <span class="synIdentifier">$results-&gt;valid_values</span> });<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;render</span>( <span class="synIdentifier">$req</span> , <span class="synConstant">'thanks'</span> );<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<span class="synStatement">else</span> {<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">$self-&gt;render</span>( <span class="synIdentifier">$req</span> , <span class="synConstant">'index'</span> , { <span class="synConstant">dv</span> =&gt; <span class="synIdentifier">$results</span> });<br />&nbsp;&nbsp;}<br />}<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>The controller is a simple Moose class, that requires <code>email_view</code>, <code>html_view</code>, and <code>verifier</code> attributes to be provided. Since we set the <code>infer</code> key on the attribute for this controller in the OX application class, OX will handle instantiating and providing all of those required services when creating our controller instance.</p>

<p>As I mentioned above, we have two methods: <code>get</code> and <code>post</code>. The <code>get</code> method simply uses the <code>render</code> method (delegated to the <code>html_view</code> attribute) to display the <code>index</code> template.</p>

<p>The real action is in the <code>post</code> method. We use the <code>verify</code> method (delegated to the <code>verifier</code> attribute) to make sure our inputs match the validation profile specified in the application configuration. If they do, use the <code>send_email</code> method (delegated to the <code>email_view</code>) to email the form data to the configured destination, and then we display a &quot;thank you&quot; page.</p>

<p>If the data verification step fails, we re-display the form page, this time providing the <a href="https://metacpan.org/module/Data::Verifier::Results">Data::Verifier::Results</a> object. Our template will use the data inside that object to provide useful feedback to our user about why the form validation failed.</p>

<h3 id="Email-View">Email View</h3>

<p>The email view class is currently implemented as a simple wrapper around <a href="https://metacpan.org/module/Email::Sender::Simple">Email::Sender::Simple</a>, <a href="https://metacpan.org/module/Email::Simple">Email::Simple</a>, and <a href="https://metacpan.org/module/Data::Printer">Data::Printer</a>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXform2email::View::Email</span>;<br /><span class="synStatement">use </span>Moose;<br /><br /><span class="synStatement">use </span>Data::Printer;<br /><span class="synStatement">use </span>Email::Sender::Simple <span class="synConstant">qw/ sendmail /</span>;<br /><span class="synStatement">use </span>Email::Simple;<br /><span class="synStatement">use </span>Email::Simple::Creator;<br /><br />has <span class="synConstant">email_from</span>    =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">email_subject</span> =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">email_to</span>      =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">send_email </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$data</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$body</span> = p <span class="synIdentifier">$data</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$email</span> = Email::Simple-&gt;create(<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">header</span> =&gt; [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">To</span>      =&gt; <span class="synIdentifier">$self-&gt;email_to</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">From</span>    =&gt; <span class="synIdentifier">$self-&gt;email_from</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">Subject</span> =&gt; <span class="synIdentifier">$self-&gt;email_subject</span> ,<br />&nbsp;&nbsp;&nbsp;&nbsp;] ,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">body</span> =&gt; <span class="synIdentifier">$body</span> ,<br />&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;sendmail( <span class="synIdentifier">$email</span> );<br />};<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>We dump the data structure out into a string, construct an email message using information that&#39;s been passed in from the application configuration, and then send that mail out.</p>

<h3 id="HTML-View">HTML View</h3>

<p>The HTML view is similiarly simple:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synStatement">package</span><span class="synType"> OXform2email::View::HTML</span>;<br /><span class="synStatement">use </span>Moose;<br /><br /><span class="synStatement">use </span>Text::Xslate;<br /><br />has <span class="synConstant">cache_dir</span>     =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br />has <span class="synConstant">template_root</span> =&gt; ( <span class="synConstant">is</span> =&gt; <span class="synConstant">'ro'</span> , <span class="synConstant">isa</span> =&gt; <span class="synConstant">'Str'</span> , <span class="synConstant">required</span> =&gt; <span class="synConstant">1</span> );<br /><br />has <span class="synConstant">xslate</span> =&gt; (<br />&nbsp;&nbsp;<span class="synConstant">is</span>      =&gt; <span class="synConstant">'ro'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">isa</span>     =&gt; <span class="synConstant">'Text::Xslate'</span> ,<br />&nbsp;&nbsp;<span class="synConstant">lazy</span>    =&gt; <span class="synConstant">1</span> ,<br />&nbsp;&nbsp;<span class="synConstant">default</span> =&gt; <span class="synStatement">sub </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">return</span> Text::Xslate-&gt;new(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">cache_dir</span> =&gt; <span class="synIdentifier">$self-&gt;cache_dir</span>  ,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synConstant">path</span>      =&gt; [ <span class="synIdentifier">$self-&gt;template_root</span> ] ,<br />&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;},<br />);<br /><br /><span class="synStatement">sub </span><span class="synIdentifier">render </span>{<br />&nbsp;&nbsp;<span class="synStatement">my</span>( <span class="synIdentifier">$self</span> , <span class="synIdentifier">$r</span> , <span class="synIdentifier">$page</span> , <span class="synIdentifier">$args</span> ) = <span class="synIdentifier">@_</span>;<br /><br />&nbsp;&nbsp;<span class="synIdentifier">$args</span> //= {};<br />&nbsp;&nbsp;<span class="synIdentifier">$args-&gt;{</span><span class="synConstant">r</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$r</span>;<br /><br />&nbsp;&nbsp;<span class="synStatement">return</span> <span class="synIdentifier">$self-&gt;xslate-&gt;render</span>( <span class="synConstant">&quot;</span><span class="synIdentifier">$page</span><span class="synConstant">.tx&quot;</span> , <span class="synIdentifier">$args</span> );<br />}<br /><br />__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;make_immutable</span>;<br /><span class="synConstant">1</span>;</code><br />&nbsp;</td></table>

<p>Here we&#39;re wrapping a <a href="https://metacpan.org/module/Text::Xslate">Text::Xslate</a> instance and proving a <code>render</code> method, which just does some argument munging and then calls the <code>render</code> method on the <code>Text::Xslate</code> instance.</p>

<h2 id="Refactorability-Included">Refactorability Included</h2>

<p>Hopefully by this point in the OX Advent calendar, you can see how easy it would be to modify the code we&#39;ve seen so far to allow the email view to send HTML emails. It would be as easy as moving the <code>Text::Xslate</code> component out of the HTML view up into the application class itself, and then making both <code>html_view</code> and <code>email_view</code> depend on that service (and adding an attribute to the email view class to store that service).</p>

<h2 id="Configuration">Configuration</h2>

<p>Let&#39;s take a quick look at the application config:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="synPreProc">---</span><br /><span class="synIdentifier">email_from</span><span class="synSpecial">:</span> <span class="synConstant">'&quot;OX Form2Email&quot; &lt;donotreply@example.com&gt;'</span><br /><span class="synIdentifier">email_to</span><span class="synSpecial">:</span> example@example.com<br /><span class="synIdentifier">email_subject</span><span class="synSpecial">:</span> <span class="synConstant">&quot;More Awesome User Feedback&quot;</span><br /><span class="synIdentifier">verifier_config</span><span class="synSpecial">:</span><br />&nbsp;&nbsp;<span class="synIdentifier">filters</span><span class="synSpecial">:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synStatement">- </span>trim<br />&nbsp;&nbsp;<span class="synIdentifier">profile</span><span class="synSpecial">:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">name</span><span class="synSpecial">:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">required</span><span class="synSpecial">:</span> <span class="synConstant">1</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">type</span><span class="synSpecial">:</span> Str<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">email</span><span class="synSpecial">:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">required</span><span class="synSpecial">:</span> <span class="synConstant">1</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">type</span><span class="synSpecial">:</span> Str<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">comment</span><span class="synSpecial">:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">required</span><span class="synSpecial">:</span> <span class="synConstant">1</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">type</span><span class="synSpecial">:</span> Str<br /><span class="synIdentifier">cache_dir</span><span class="synSpecial">:</span> /tmp/oxform2email<br /><span class="synIdentifier">static_root</span><span class="synSpecial">:</span> ./static<br /><span class="synIdentifier">template_root</span><span class="synSpecial">:</span> tx</code><br />&nbsp;</td></table>

<p>You can see we have the input validation config embedded right in the middle there -- 3 fields, name, email, and a comment, all required. Making the verification profile part of the configuration means it&#39;s easy to adapt to new forms -- no code needs to change.</p>

<h2 id="My-Templates-Let-Me-Show-You-Them">My Templates, Let Me Show You Them</h2>

<p>The application is using <a href="https://metacpan.org/module/Text::Xslate">Text::Xslate</a> and a small set of form generation macros. I&#39;m not going to show the macros here -- they&#39;re in <a href="https://github.com/genehack/oxform2mail">the repository</a> if you&#39;re interested -- but they pretty much do what you&#39;d expect in terms of generating input fields that have the appropriate Bootstrap classes applied. The macros will also make use of the provided <a href="https://metacpan.org/module/Data::Verifier">Data::Verifier</a> instance to indicate missing required fields, and to restore the value of form fields when needed. Here&#39;s what the <code>index</code> template looks like:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code>: my $title = 'We Welcome Your Feedback'<br />: cascade wrapper with macros { title =<span class="synError">&gt;</span> $title }<br /><br />: override content -<span class="synError">&gt;</span> {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;&lt;: $title :&gt;&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;: if( $dv and ! $dv.success ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;error&quot;</span><span class="synIdentifier">&gt;</span>ERROR!<span class="synIdentifier">&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;: }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;</span><span class="synStatement">form</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;form-horizontal&quot;</span><span class="synIdentifier"> </span><span class="synType">action</span><span class="synIdentifier">=</span><span class="synConstant">&quot;&lt;: $r.uri_for( 'index' ) :&gt;&quot;</span><span class="synIdentifier"> </span><span class="synType">method</span><span class="synIdentifier">=</span><span class="synConstant">&quot;POST&quot;</span><span class="synIdentifier">&gt;</span><br />&nbsp;&nbsp;: textfield( 'name' , 'Your name' );<br />&nbsp;&nbsp;: textfield( 'email' , 'Your email' );<br />&nbsp;&nbsp;: textarea( 'comment' , 'Your comment' );<br />&nbsp;&nbsp;: submit( 'submit' , 'Give Us Your Thoughts' );<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="synIdentifier">&lt;/</span><span class="synStatement">form</span><span class="synIdentifier">&gt;</span><br />: }</code><br />&nbsp;</td></table>

<p>The <code>textfield</code>, <code>textarea</code>, and <code>submit</code> macros are all defined in the base <code>wrapper.tx</code>. The other thing to note in this template is the use of the <code>uri_for</code> method being called on the <a href="https://metacpan.org/module/OX::Request">OX::Request</a> object that is added into the argument list.</p>

<h2 id="Patches-Welcome">Patches Welcome</h2>

<p>My friend&#39;s form needs were modest (and getting me involved eventually shamed her internal IT department into doing the work for her, so my version wasn&#39;t used, in the end), but with a bit more work on the <code>macros.tx</code> file, to add more form element types, this simple application could be an easy drop-in-place form to email gateway. Hopefully seeing this example of an easily deployable, configurable, PSGI-pluggable OX application inspires you to give OX a shot the next time you need to do a quick favor for a friend (or even the next time you need to do a large project for work...)</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/89415c88230cf6205f7518a6264c9aae?r=g&s=80&d=retro />
This article contributed by: John SJ Anderson &lt;john.anderson@iinteractive.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Authentication III: Return Of The Middleware" href="2012-12-22.html">Previous</a></li>

    <li class="next"><a title="Wrapping things up" href="2012-12-24.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



</body>
</html>





